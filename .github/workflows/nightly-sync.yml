name: Nightly Full Sync (Production)

on:
  schedule:
    - cron: '0 22 * * *'  # 22:00 UTC = 00:00 CEST (midnight Warsaw time)
  workflow_dispatch:  # Manual trigger

jobs:
  full-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:

      - name: Batch 1 (pages 1-50, clear DB)
        run: |
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=1" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 2 (pages 51-100)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=2" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 3 (pages 101-150)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=3" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 4 (pages 151-200)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=4" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 5 (pages 201-250)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=5" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 6 (pages 251-300)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=6" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 7 (pages 301-350)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=7" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 8 (pages 351-400)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=8" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 9 (pages 401-450)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=9" \
            -H "x-github-action: true" --max-time 150

      - name: Batch 10 (pages 451-500)
        run: |
          sleep 10
          curl -X POST "https://gbylzdyyhnvmrgfgpfqh.supabase.co/functions/v1/full-sync?batch=10" \
            -H "x-github-action: true" --max-time 150

      - name: Backfill message history
        run: |
          echo "Waiting for sync to settle..."
          sleep 30
          echo "Running backfill to sync message_history from internal_note..."
          curl -X POST "${{ secrets.VERCEL_URL }}/api/historia/backfill" \
            -H "Content-Type: application/json" \
            --max-time 300

      - name: Fix EMAIL_1 for Fakturownia-sent invoices
        run: |
          echo "Fixing EMAIL_1 flags for invoices sent by Fakturownia..."
          curl -X POST "${{ secrets.VERCEL_URL }}/api/sync/fix-email-status" \
            -H "Content-Type: application/json" \
            -H "x-github-action: true" \
            --max-time 300

      - name: Log Completion
        if: always()
        run: |
          echo "::notice::Nightly sync workflow completed. Check GitHub Actions logs for details."
