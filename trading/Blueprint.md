# ğŸ§  Prompt dla Claude Code â€” Projekt Fiscal Sync

## ğŸ¯ Cel
Zbuduj kompletny system **Fiscal Sync** â€” integracjÄ™ miÄ™dzy **Fakturownia**, **Supabase** i **n8n**, umoÅ¼liwiajÄ…cÄ… biurom rachunkowym zarzÄ…dzanie przypomnieniami (e-mail / SMS / WhatsApp) o nieopÅ‚aconych fakturach.

---

## ğŸ”§ Kontekst

Mam juÅ¼:
- âœ… DostÄ™p do **Fakturownia API** (repozytorium sklonowane w Claude Code)
- âœ… DziaÅ‚ajÄ…cy **workflow w n8n** â€” wklejÄ™ jego JSON poniÅ¼ej
- âœ… Gotowy projekt **Supabase** z tabelami `clients`, `invoices`, `invoice_comments`
- âœ… Dokument `CLAUDE.md` z zasadami implementacji (styl, workflow, standardy)

Twoim zadaniem jest:
> NapisaÄ‡ **peÅ‚nÄ… implementacjÄ™ aplikacji Fiscal Sync** â€” backend, frontend, integracja z API i Supabase.

---

## ğŸ§© Opis funkcjonalny

### 1. GÅ‚Ã³wna idea
UÅ¼ytkownik (ksiÄ™gowy / biuro) korzysta z prostego panelu:
- widzi wszystkich klientÃ³w i ich faktury (synchronizowane z Fakturowni â†’ Supabase),
- moÅ¼e wysyÅ‚aÄ‡ przypomnienia (`Send Email`, `Send SMS`, `Send WhatsApp`),
- moÅ¼e wÅ‚Ä…czyÄ‡ / wyÅ‚Ä…czyÄ‡ opcjÄ™ **STOP** (czyli â€nie wysyÅ‚aj juÅ¼ przypomnieÅ„â€),
- wszystkie akcje automatycznie zapisujÄ… siÄ™ jako komentarze w Fakturowni oraz aktualizujÄ… dane w Supabase.

---

## ğŸ’¬ Struktura komentarza (Fakturownia)

KaÅ¼da faktura i klient majÄ… jedno pole `comment`, w ktÃ³rym trzymana jest struktura:

[FISCAL_SYNC]
EMAIL_1=TRUE
EMAIL_2=FALSE
EMAIL_3=FALSE
SMS_1=TRUE
SMS_2=FALSE
SMS_3=FALSE
STOP=FALSE
UPDATED=2025-10-05T10:45:00Z
[/FISCAL_SYNC]

markdown
Copy code

Zasady:
- JeÅ›li komentarz nie istnieje â†’ utwÃ³rz caÅ‚Ä… strukturÄ™ z wartoÅ›ciami `FALSE`.
- Zawsze parsuj istniejÄ…cy komentarz.
- Aktualizuj tylko pojedyncze pola (`EMAIL_2`, `STOP`, itp.).
- Po kaÅ¼dej akcji nadpisz sekcjÄ™ `[FISCAL_SYNC]` i zapisz jÄ… z powrotem do Fakturowni.
- Zaktualizuj teÅ¼ dane w Supabase.

---

## ğŸ”„ Model synchronizacji

### ğŸ•› A. PeÅ‚ny refresh (raz dziennie)
- Uruchamiany przez cron w n8n (np. 3:00 w nocy).
- Pobiera wszystkie faktury, klientÃ³w i komentarze z Fakturowni.
- Nadpisuje dane w Supabase.
- Usuwa rekordy, ktÃ³rych juÅ¼ nie ma w Fakturowni.
- Endpoint:  
  `GET /invoices.json?page=...&per_page=200`

### âš¡ B. CzÄ™Å›ciowa synchronizacja (po akcji uÅ¼ytkownika)
KaÅ¼da akcja uÅ¼ytkownika (e-mail / SMS / STOP):
1. WysyÅ‚a webhook do n8n (do wysyÅ‚ki wiadomoÅ›ci),
2. Aktualizuje komentarz w Fakturowni (`PUT /invoices/:id.json`),
3. WysyÅ‚a Å¼Ä…danie `GET /invoices.json?sort=updated_at&order=desc&per_page=100`  
   aby zsynchronizowaÄ‡ najnowsze zmodyfikowane faktury (pseudo-webhook).

---

## âš™ï¸ Architektura systemu

### 1. Frontend (Next.js / Cloud Code)
- Minimalny CRM-owy panel z listÄ… klientÃ³w i faktur.
- Filtry: â€nieopÅ‚aconeâ€, â€STOPâ€.
- Przyciski akcji: `Send Email`, `Send SMS`, `Toggle STOP`.
- KaÅ¼da akcja wywoÅ‚uje endpointy:
  - `/api/reminder`
  - `/api/sync`
  - `/api/invoice/:id`

### 2. Backend (API Routes)
- Implementacja w TypeScript.
- ObsÅ‚uga bÅ‚Ä™dÃ³w i walidacja danych (Zod).
- Integracja z Fakturownia API i Supabase.
- KaÅ¼da akcja uÅ¼ytkownika:
  - WysyÅ‚a webhook do n8n,
  - Aktualizuje komentarz w Fakturowni,
  - Dopisuje historiÄ™ do tabeli `invoice_comments` w Supabase.

### 3. Supabase â€” struktura bazy danych

```sql
CREATE TABLE clients (
  id BIGINT PRIMARY KEY,
  name TEXT,
  email TEXT,
  phone TEXT,
  total_unpaid NUMERIC,
  updated_at TIMESTAMP
);

CREATE TABLE invoices (
  id BIGINT PRIMARY KEY,
  client_id BIGINT REFERENCES clients(id),
  number TEXT,
  total NUMERIC,
  status TEXT,
  comment TEXT,
  updated_at TIMESTAMP
);

CREATE TABLE invoice_comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  invoice_id BIGINT REFERENCES invoices(id),
  body TEXT,
  created_at TIMESTAMP DEFAULT now(),
  source TEXT CHECK (source IN ('fakturownia','local'))
);
ğŸ§° Wymagania techniczne
StwÃ³rz parser i generator komentarzy:

parseFiscalSync(comment: string)

updateFiscalSync(comment: string, field: string, value: boolean): string

Wszystko pisz w TypeScript.

Klucze API i dane uwierzytelniajÄ…ce w .env.

Respektuj limity Fakturownia API (1000 req/h).

Dodaj sleep(1200) miÄ™dzy Å¼Ä…daniami przy batchowaniu.

UÅ¼ywaj per_page=100 przy incremental fetchach.

Dodaj logging wszystkich operacji synchronizacji.

UI ma byÄ‡ optymistyczny (natychmiastowa aktualizacja stanu po klikniÄ™ciu).

ğŸ¨ UX wymagania
Prosty, przejrzysty interfejs dla nietechnicznych ksiÄ™gowych.

KaÅ¼da akcja â†’ natychmiastowy feedback (toast.success, toast.error).

Checkbox â€STOPâ€ â†’ zmienia wartoÅ›Ä‡ STOP=TRUE/FALSE w komentarzu faktury.

Tabele szybkie i responsywne (SWR lub React Query).

ğŸ§± Deliverables
Claude, Twoje zadanie to stworzyÄ‡ kompletny projekt Fiscal Sync, zawierajÄ…cy:

Next.js / Cloud Code projekt z folderami:

/app

/lib

/components

/api

IntegracjÄ™ z Supabase (createServerClient)

Helpery do parsowania komentarzy

API Routes:

/api/sync

/api/reminder

/api/invoice/[id]

UI:

Dashboard z listÄ… klientÃ³w i faktur

Przyciski akcji (e-mail, SMS, STOP)

Toastery, loading states, bÅ‚Ä™dy

README.md z instrukcjÄ… uruchomienia

Zastosowanie zasad z CLAUDE.md (planowanie, checkpointy, bezpieczeÅ„stwo)

ğŸ§© Dane wejÅ›ciowe
Po tym promptcie wklejÄ™:

MÃ³j workflow JSON z n8n (z webhookami do wysyÅ‚ki przypomnieÅ„)

Ewentualnie dane poÅ‚Ä…czenia z Supabase (url, anon key, service key)

Twoje zadanie:

przeanalizowaÄ‡ ten JSON,

poÅ‚Ä…czyÄ‡ aplikacjÄ™ tak, by dziaÅ‚aÅ‚a end-to-end z moim n8n.

ğŸ§  Oczekiwania dotyczÄ…ce wyniku
Claude powinien:

wygenerowaÄ‡ caÅ‚y kod projektu (Next.js / Cloud Code),

dodaÄ‡ wszystkie pliki w logicznej strukturze repozytorium,

nie uÅ¼ywaÄ‡ placeholderÃ³w typu TODO,

uÅ¼yÄ‡ typÃ³w i komentarzy w kodzie,

zastosowaÄ‡ wzorce z CLAUDE.md,

uÅ¼yÄ‡ dokÅ‚adnie opisanej logiki [FISCAL_SYNC].

âš™ï¸ Oczekiwany efekt koÅ„cowy
Po wdroÅ¼eniu aplikacji:

Biuro rachunkowe ma prosty panel,

KaÅ¼da akcja (wysyÅ‚ka, STOP) natychmiast zapisuje siÄ™ w Fakturowni i Supabase,

System dziaÅ‚a stabilnie w ramach limitÃ³w API,

CaÅ‚oÅ›Ä‡ jest czytelna, bezpieczna i Å‚atwa do rozbudowy.

ğŸª„ Dalsze kroki
Nie generuj jeszcze kodu.
Najpierw:

Poczekaj na wklejenie mojego workflow JSON z n8n.

Po otrzymaniu â€” przeanalizuj strukturÄ™ webhookÃ³w i rozpocznij generowanie projektu.

ğŸ”š Podsumowanie
Zadanie:
ZbudowaÄ‡ kompletny system Fiscal Sync Å‚Ä…czÄ…cy:

Fakturownia API (pobieranie i aktualizacja faktur + komentarzy),

Supabase (baza klientÃ³w, faktur i historii akcji),

n8n (automatyzacja wysyÅ‚ek wiadomoÅ›ci),

UI (panel CRM dla ksiÄ™gowych).

Wszystko w TypeScript, Next.js / Cloud Code, zgodnie z zasadami CLAUDE.md.