# Database Migrations

Migracje bazy danych dla projektu Carebiuro Windykacja.

## Kolejność wykonywania

Uruchom w Supabase SQL Editor w następującej kolejności:

### 1. Główna schema (jeśli tabele nie istnieją)
```sql
-- Uruchom: supabase-schema.sql
-- UWAGA: Zakomentuj linię 107 (idx_clients_list_polecony) jeśli wywala błąd
```

### 2. Migration 001: Add list_polecony
```sql
-- Uruchom: migrations/001_add_list_polecony.sql
-- Dodaje kolumnę list_polecony do tabeli clients
-- Bezpieczne - sprawdza czy kolumna istnieje przed dodaniem
```

### 3. Migration 002: Add message_history
```sql
-- Uruchom: migrations/002_add_message_history.sql
-- Tworzy tabelę message_history z indeksami
-- Bezpieczne - używa IF NOT EXISTS
```

## Szybkie uruchomienie

Skopiuj i wklej do Supabase SQL Editor w tej kolejności:

```sql
-- KROK 1: Dodaj list_polecony (jeśli nie istnieje)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'clients'
    AND column_name = 'list_polecony'
  ) THEN
    ALTER TABLE clients ADD COLUMN list_polecony BOOLEAN DEFAULT false;
  END IF;
END $$;

CREATE INDEX IF NOT EXISTS idx_clients_list_polecony
ON clients(list_polecony)
WHERE list_polecony = true;

-- KROK 2: Dodaj message_history
CREATE TABLE IF NOT EXISTS message_history (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  client_id BIGINT REFERENCES clients(id) ON DELETE CASCADE,
  invoice_id BIGINT REFERENCES invoices(id) ON DELETE CASCADE,
  invoice_number TEXT NOT NULL,
  client_name TEXT NOT NULL,
  message_type TEXT NOT NULL CHECK (message_type IN ('email', 'sms', 'whatsapp')),
  level INTEGER NOT NULL CHECK (level IN (1, 2, 3)),
  status TEXT NOT NULL CHECK (status IN ('sent', 'failed')),
  error_message TEXT,
  sent_at TIMESTAMP DEFAULT now(),
  sent_by TEXT DEFAULT 'system',
  is_auto_initial BOOLEAN DEFAULT false,
  invoice_total NUMERIC,
  invoice_currency TEXT
);

CREATE INDEX IF NOT EXISTS idx_message_history_client_id ON message_history(client_id);
CREATE INDEX IF NOT EXISTS idx_message_history_invoice_id ON message_history(invoice_id);
CREATE INDEX IF NOT EXISTS idx_message_history_sent_at ON message_history(sent_at DESC);
CREATE INDEX IF NOT EXISTS idx_message_history_message_type ON message_history(message_type);
CREATE INDEX IF NOT EXISTS idx_message_history_level ON message_history(level);
CREATE INDEX IF NOT EXISTS idx_message_history_is_auto_initial ON message_history(is_auto_initial) WHERE is_auto_initial = true;
```

## Weryfikacja

Po uruchomieniu sprawdź czy tabele istnieją:

```sql
-- Sprawdź czy message_history istnieje
SELECT COUNT(*) FROM message_history;

-- Sprawdź czy list_polecony został dodany
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'clients'
AND column_name = 'list_polecony';
```

## Historia migracji

| Nr | Nazwa | Data | Opis |
|----|-------|------|------|
| 001 | add_list_polecony | 2025-10-07 | Dodaje kolumnę list_polecony do clients |
| 002 | add_message_history | 2025-10-07 | Tworzy tabelę message_history dla historii wysyłek |

## Troubleshooting

### Błąd: "column list_polecony does not exist"
**Rozwiązanie**: Uruchom migrację 001

### Błąd: "relation message_history does not exist"
**Rozwiązanie**: Uruchom migrację 002

### Błąd: "column already exists"
**Rozwiązanie**: Migracja jest już wykonana, możesz pominąć
